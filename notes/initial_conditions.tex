\documentclass{article}

\usepackage[T1]{fontenc}
\usepackage{textcomp}
\usepackage[american]{babel}
\usepackage[utf8]{inputenc}
\usepackage[babel=true]{microtype}
\usepackage{geometry}
\usepackage{lmodern}
\usepackage{datetime2}
\usepackage{amsmath}
\usepackage{units}
\usepackage{multirow}
\usepackage{csquotes}
\usepackage{tikz}
\usepackage[style=authoryear-clean]{biblatex}
\usepackage[hidelinks]{hyperref}

\renewcommand{\vec}[1]{\mathbf{#1}}
\newcommand{\mat}[1]{\mathbf{#1}}
\DeclareMathOperator{\Prob}{Prob}
\newcommand{\md}{\mathrm{d}}

\addbibresource{initial_conditions.bib}

\title{Initial conditions}
\author{
  Jan Medlock \and Ricardo NoÃ© Gerardo Reyes Grimaldo
  \and Erin Gorisch \and Brianna Beechler \and Peter Buss
  \and Bryan Charleston \and Brian Dugovich \and Simon Gubbins
  \and Anna Jolles \and Nick Juleff \and Lin-Mari de Klerk-Lorist
  \and Francois Maree \and Eva Perez-Martin \and O.L.~van Schalkwyk
  \and Katherine Scott \and Fuquan Zhang
}

\begin{document}

\maketitle

\section{Model}

We simplified the larger problem by using
\begin{itemize}
\item the birth hazard that is constant in time, and
\item the hazard for antibody gain that is constant in time.
\end{itemize}
We found the endemic equilibrium of this problem by iteratively
solving for the fixed point of the hazard of infection,
$h_{\text{infection}}$, and the fraction of newborns with maternal
immunity, $\phi_{\text{maternal immunity}}$. With given values of
$h_{\text{infection}}$ and $\phi_{\text{maternal immunity}}$, we
solved a linear-algebra problem for the endemic equilibrium
probability densities as a function of model compartment, age, and
duration in the current compartment
(\autoref{model_diagram}), i.e.
\begin{subequations}
  \begin{align}
    P_{\mathrm{M}}(a)
    &= \Prob\{\text{in compartment $\mathrm{M}$ at age $a$}\},\\
    P_{\mathrm{S}}(a)
    &= \Prob\{\text{in compartment $\mathrm{S}$ at age $a$}\},\\
    p_{\mathrm{E}}(a, r)
    &= \Prob\{\text{in compartment $\mathrm{E}$ at age $a$ and
      duration $r$}\},\\
    p_{\mathrm{I}}(a, r)
    &= \Prob\{\text{in compartment $\mathrm{I}$ at age $a$ and
      duration $r$}\},\\
    p_{\mathrm{C}}(a, r)
    &= \Prob\{\text{in compartment $\mathrm{C}$ at age $a$ and
      duration $r$}\},\\
    P_{\mathrm{R}}(a)
    &= \Prob\{\text{in compartment $\mathrm{R}$ at age $a$}\},\\
    P_{\mathrm{L}}(a)
    &= \Prob\{\text{in compartment $\mathrm{L}$ at age $a$}\},
  \end{align}
\end{subequations}
for $a \geq 0$ and $0 \leq r \leq a$.
These $P_X(a)$ and $p_X(a, r)$ were then used to iteratively update
$h_{\text{infection}}$ and $\phi_{\text{maternal immunity}}$. Finally,
the equilibrium densities $P_X(a)$ were found at this fixed point.

\begin{figure}
  \begin{center}
    \include{diagram}
  \end{center}
  \caption{Model diagram.}
  \label{model_diagram}
\end{figure}

For $a > 0$ and $0 < r \leq a$, the equilibrium probability densities
satisfy
\begin{subequations}
  \label{model}
  \begin{align}
    P_{\mathrm{M}}(0)
    &= \phi_{\text{maternal immunity}},
    \\
    \frac{\md P_{\mathrm{M}}}{\md a}
    &= - \left[h_{\text{waning}}(a) + h_{\text{death}}(a)\right]
      P_{\mathrm{M}}(a),
    \displaybreak[0]\\
    P_{\mathrm{S}}(0)
    &= 1 - \phi_{\text{maternal immunity}},
    \\
    \frac{\md P_{\mathrm{S}}}{\md a}
    &= h_{\text{waning}}(a) P_{\mathrm{M}}(a)
      - \left[h_{\text{infection}} + h_{\text{death}}(a)\right]
      P_{\mathrm{S}}(a),
    \displaybreak[0]\\
    p_{\mathrm{E}}(0, 0)
    &= h_{\text{infection}}
      \left[P_{\mathrm{S}}(0)
      + \sigma_{\text{lost immunity}} P_{\mathrm{L}}(0)\right],
    \\
    p_{\mathrm{E}}(a, 0)
    &= h_{\text{infection}}
      \left[P_{\mathrm{S}}(a)
      + \sigma_{\text{lost immunity}} P_{\mathrm{L}}(a)\right],
    \\
    \left(\frac{\partial}{\partial a}
    + \frac{\partial}{\partial r}\right)
    p_{\mathrm{E}}
    &= - \left[h_{\text{progression}}(r) + h_{\text{death}}(a)\right]
      p_{\mathrm{E}}(a, r),
    \displaybreak[0]\\
    p_{\mathrm{I}}(0, 0) &= 0,
    \\
    p_{\mathrm{I}}(a, 0)
    &= \int_0^a h_{\text{progression}}(r)
      p_{\mathrm{E}}(a, r) \md r,
    \\
    \left(\frac{\partial}{\partial a}
    + \frac{\partial}{\partial r}\right)
    p_{\mathrm{I}}
    &= - \left[h_{\text{recovery}}(r) + h_{\text{death}}(a)\right]
      p_{\mathrm{I}}(a, r),
    \displaybreak[0]\\
    p_{\mathrm{C}}(0, 0) &= 0,
    \\
    p_{\mathrm{C}}(a, 0)
    &= p_{\text{carrier}}
      \int_0^a h_{\text{recovery}}(r) p_{\mathrm{I}}(a, r) \md r,
    \\
    \left(\frac{\partial}{\partial a}
    + \frac{\partial}{\partial r}\right)
    p_{\mathrm{C}}
    &= - \left[h_{\text{carrier recovery}}(r) + h_{\text{death}}(a)\right]
      p_{\mathrm{C}}(a, r),
    \displaybreak[0]\\
    P_{\mathrm{R}}(0) &= 0,
    \\
    \begin{split}
      \frac{\md P_{\mathrm{R}}}{\md a} &=
      \left(1 - p_{\text{carrier}}\right)
      \int_0^a h_{\text{recovery}}(r) p_{\mathrm{I}}(a, r) \md r
      \\ & \quad {}
      + \int_0^a h_{\text{carrier recovery}}(r) p_{\mathrm{C}}(a, r) \md r
      \\ & \quad {}
      + h_{\text{antibody gain}} P_{\mathrm{L}}(a)
      \\ & \quad {}
      - \left[h_{\text{antibody loss}} + h_{\text{death}}(a)\right]
      P_{\mathrm{R}}(a),
    \end{split}
    \displaybreak[0]\\
    P_{\mathrm{L}}(0) &= 0,
    \\
    \begin{split}
      \frac{\md P_{\mathrm{L}}}{\md a} &=
      h_{\text{antibody loss}} P_{\mathrm{R}}(a)
      \\ & \quad {}
      - \left[h_{\text{antibody gain}}
        + \sigma_{\text{lost immunity}} h_{\text{infection}}
        + h_{\text{death}}(a)\right]
      P_{\mathrm{L}}(a),
    \end{split}
  \end{align}
\end{subequations}
with
\begin{subequations}
  \begin{align}
    P_{\mathrm{E}}(a) &= \int_0^a p_{\mathrm{E}}(a, r) \md r,
    \displaybreak[0]\\
    P_{\mathrm{I}}(a) &= \int_0^a p_{\mathrm{I}}(a, r) \md r,
    \displaybreak[0]\\
    P_{\mathrm{C}}(a) &= \int_0^a p_{\mathrm{C}}(a, r) \md r.
  \end{align}
\end{subequations}

The infection hazard is
\begin{equation}
  h_{\text{infection}} =
  \int_0^{+\infty}
  \beta_{\text{infectious}} P_{\mathrm{I}}(a)
  + \beta_{\text{carrier}} P_{\mathrm{C}}(a)
  \md a
\end{equation}
and the proportion of births that have maternal immunity is
\begin{equation}
  \phi_{\text{maternal immunity}}
  = \frac{
    \int_0^{+\infty} h_{\text{birth}}(a)
    \left[P_{\mathrm{C}}(a) + P_{\mathrm{R}}(a)\right]
    \md a
  }{
    \int_0^{+\infty} h_{\text{birth}}(a) P(a) \md a
  },
\end{equation}
where
\begin{equation}
  P(a)
  = P_{\mathrm{M}}(a) + P_{\mathrm{S}}(a) + P_{\mathrm{E}}(a)
  + P_{\mathrm{I}}(a) + P_{\mathrm{C}}(a) + P_{\mathrm{R}}(a)
  + P_{\mathrm{L}}(a).
\end{equation}


\subsection{Analysis}

Integrating the PDEs for $p_{\mathrm{E}}$, $p_{\mathrm{I}}$, and
$p_{\mathrm{C}}$ in model \eqref{model} along the characteristics
$r = a - a_0$ gives
\begin{subequations}
  \begin{align}
    P_{\mathrm{M}}(0)
    &= \phi_{\text{maternal immunity}},
    \\
    \frac{\md P_{\mathrm{M}}}{\md a}
    &= - \left[h_{\text{waning}}(a) + h_{\text{death}}(a)\right]
      P_{\mathrm{M}}(a),
    \displaybreak[0]\\
    P_{\mathrm{S}}(0)
    &= 1 - \phi_{\text{maternal immunity}},
    \\
    \frac{\md P_{\mathrm{S}}}{\md a}
    &= h_{\text{waning}}(a) P_{\mathrm{M}}(a)
      - \left[h_{\text{infection}}  + h_{\text{death}}(a)\right]
      P_{\mathrm{S}}(a),
    \displaybreak[0]\\
    p_{\mathrm{E}}(0, 0)
    &= h_{\text{infection}}
      \left[P_{\mathrm{S}}(0)
      + \sigma_{\text{lost immunity}} P_{\mathrm{L}}(0)\right],
    \\
    p_{\mathrm{E}}(a, 0)
    &= h_{\text{infection}}
      \left[P_{\mathrm{S}}(a)
      + \sigma_{\text{lost immunity}} P_{\mathrm{L}}(a)\right],
    \\
    p_{\mathrm{E}}(a, r)
    &= S_{\text{progression}}(r)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a - r)}
      p_{\mathrm{E}}(a - r, 0),
    \displaybreak[0]\\
    p_{\mathrm{I}}(0, 0) &= 0,
    \\
    p_{\mathrm{I}}(a, 0)
    &= \int_0^a
      p_{\text{progression}}(r)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a - r)}
      p_{\mathrm{E}}(a - r, 0)
      \md r,
    \\
    p_{\mathrm{I}}(a, r)
    &= S_{\text{recovery}}(r)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a - r)}
      p_{\mathrm{I}}(a - r, 0),
    \displaybreak[0]\\
    p_{\mathrm{C}}(0, 0) &= 0,
    \\
    p_{\mathrm{C}}(a, 0)
    &= p_{\text{carrier}}
      \int_0^a
      p_{\text{recovery}}(r)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a - r)}
      p_{\mathrm{I}}(a - r, 0)
      \md r,
    \\
    p_{\mathrm{C}}(a, r)
    &= S_{\text{carrier recovery}}(r)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a - r)}
      p_{\mathrm{C}}(a - r, 0),
    \displaybreak[0]\\
    P_{\mathrm{R}}(0) &= 0,
    \\
    \begin{split}
      \frac{\md P_{\mathrm{R}}}{\md a} &=
      \left(1 - p_{\text{carrier}}\right)
      \int_0^a
      p_{\text{recovery}}(r)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a - r)}
      p_{\mathrm{I}}(a - r, 0)
      \md r
      \\ & \quad {}
      + \int_0^a
      p_{\text{carrier recovery}}(r)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a - r)}
      p_{\mathrm{C}}(a - r, 0)
      \md r
      \\ & \quad {}
      + h_{\text{antibody gain}} P_{\mathrm{L}}(a)
      \\ & \quad {}
      - \left[h_{\text{antibody loss}}  + h_{\text{death}}(a)\right]
      P_{\mathrm{R}}(a),
    \end{split}
    \displaybreak[0]\\
    P_{\mathrm{L}}(0) &= 0,
    \\
    \begin{split}
      \frac{\md P_{\mathrm{L}}}{\md a}
      &= h_{\text{antibody loss}} P_{\mathrm{R}}(a)
      \\ & \quad {}
      - \left[h_{\text{antibody gain}}
        + \sigma_{\text{lost immunity}} h_{\text{infection}}
        + h_{\text{death}}(a)\right]
      P_{\mathrm{L}}(a).
    \end{split}
  \end{align}
\end{subequations}

Using
\begin{subequations}
  \label{eq:integrals_over_r}
  \begin{align}
    P_{\mathrm{E}}(a)
    &= \int_0^a
      S_{\text{progression}}(a - a_0)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a_0)}
      p_{\mathrm{E}}(a_0, 0)
      \md a_0,
    \displaybreak[0]\\
    P_{\mathrm{I}}(a)
    &= \int_0^a
      S_{\text{recovery}}(a - a_0)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a_0)}
      p_{\mathrm{I}}(a_0, 0)
      \md a_0,
    \displaybreak[0]\\
    P_{\mathrm{C}}(a)
    &= \int_0^a
      S_{\text{carrier recovery}}(a - a_0)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a_0)}
      p_{\mathrm{C}}(a_0, 0)
      \md a_0,
  \end{align}
\end{subequations}
gives
\begin{subequations}
  \label{eq:integrals_derivatives}
  \begin{align}
    \begin{split}
      \frac{\md P_{\mathrm{E}}}{\md a}
      &= h_{\text{infection}}
      \left[P_{\mathrm{S}}(a)
        + \sigma_{\text{lost immunity}} P_{\mathrm{L}}(a)\right]
      \\ & \quad {}
      - \int_0^a
      p_{\text{progression}}(r)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a - r)}
      p_{\mathrm{E}}(a - r, 0)
      \md r
      \\ & \quad {}
      - h_{\text{death}}(a) P_{\mathrm{E}}(a),
    \end{split}
    \displaybreak[0]\\
    \begin{split}
      \frac{\md P_{\mathrm{I}}}{\md a}
      &= \int_0^a
      p_{\text{progression}}(r)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a - r)}
      p_{\mathrm{E}}(a - r, 0) \md r
      \\ & \quad {}
      - \int_0^a
      p_{\text{recovery}}(r)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a - r)}
      p_{\mathrm{I}}(a - r, 0)
      \md r
      \\ & \quad {}
      - h_{\text{death}}(a) P_{\mathrm{I}}(a),
    \end{split}
    \displaybreak[0]\\
    \begin{split}
      \frac{\md P_{\mathrm{C}}}{\md a}
      &= p_{\text{carrier}}
      \int_0^a
      p_{\text{recovery}}(r)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a - r)}
      p_{\mathrm{I}}(a - r, 0)
      \md r
      \\ & \quad {}
      - \int_0^a
      p_{\text{carrier recovery}}(r)
      \frac{S_{\text{death}}(a)}{S_{\text{death}}(a - r)}
      p_{\mathrm{C}}(a - r, 0)
      \md r
      \\ & \quad {}
      - h_{\text{death}}(a) P_{\mathrm{C}}(a).
    \end{split}
  \end{align}
\end{subequations}
Then
\begin{subequations}
  \begin{align}
    \frac{\md P}{\md a}
    &= - h_{\text{death}}(a) P(a), \\
    P(0) &= 1,
  \end{align}
\end{subequations}
so that
\begin{equation}
  P(a) = S_{\text{death}}(a).
\end{equation}

The constant-time birth hazard
(i.e.~$c_{\mathrm{v}} = 0$)
\begin{equation}
  h_{\text{birth}}(a) =
  \begin{cases}
    0 & \text{if $a < 4$}, \\
    \mu & \text{if $a \geq 4$},
  \end{cases}
\end{equation}
with
\begin{equation}
  \mu =
  \left[
    \int_4^{+\infty} S_{\text{death}}(a) \md a
  \right]^{-1},
\end{equation}
gives
\begin{equation}
  \int_0^{+\infty} h_{\text{birth}}(a) P(a) \md a
  = \int_0^{+\infty} h_{\text{birth}}(a) S_{\text{death}}(a) \md a
  = 1
  = P(0),
\end{equation}
so that the population size is constant, i.e.~zero growth rate.


\section{Numerical method}

To solve the system \eqref{model} for the probability densities, we
used the Crank--Nicolson method on characteristics and the composite
trapezoid rule for the integrals \autocite{milner_1992}.  Given the
age step $\Delta a$, for $i \in \{0, 1, 2, \ldots, I - 1\}$ and
$j \in \{0, 1, 2, \ldots, i\}$, let $a^i = i \Delta a$, $r^j = j
\Delta a$, $P_X^i \approx P_X(a^i)$, and
$p_X^i \approx p_X(a^i, 0)$.
For each $i \in \{1, 2, \ldots, I - 1\}$, using the
Crank--Nicolson method on characteristics is
\begin{subequations}
  \label{eq:numerical_method}
  \begin{align}
    P_{\mathrm{M}}^0
    &= \phi_{\text{maternal immunity}},
    \\
    \frac{P_{\mathrm{M}}^i - P_{\mathrm{M}}^{i - 1}}{\Delta a}
    &= - \left[
      h_{\text{waning}}(a^{i - 1 / 2})
      + h_{\text{death}}(a^{i - 1 / 2})
      \right]
      \frac{P_{\mathrm{M}}^i + P_{\mathrm{M}}^{i - 1}}{2},
    \displaybreak[0]\\
    P_{\mathrm{S}}^0
    &= 1 - \phi_{\text{maternal immunity}},
    \\
    \begin{split}
      \frac{P_{\mathrm{S}}^i - P_{\mathrm{S}}^{i - 1}}{\Delta a}
      &= h_{\text{waning}}(a^{i - 1 / 2})
      \frac{P_{\mathrm{M}}^i + P_{\mathrm{M}}^{i - 1}}{2}
      \\ & \quad {}
      - \left[
        h_{\text{infection}}
        + h_{\text{death}}(a^{i - 1 / 2})
      \right]
      \frac{P_{\mathrm{S}}^i + P_{\mathrm{S}}^{i - 1}}{2},
    \end{split}
    \displaybreak[0]\\
    p_{\mathrm{E}}^0 &= 0,
    \\
    p_{\mathrm{E}}^i
    &= h_{\text{infection}} \left(
      \frac{P_{\mathrm{S}}^i + P_{\mathrm{S}}^{i - 1}}{2}
      + \sigma_{\text{lost immunity}}
      \frac{P_{\mathrm{L}}^i + P_{\mathrm{L}}^{i - 1}}{2}
      \right),
    \displaybreak[0]\\
    p_{\mathrm{I}}^0 &= 0,
    \\
    p_{\mathrm{I}}^i
    &= \sum_{j = 0}^i
      p_{\text{progression}}(r^j)
      \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^{i - j})}
      p_{\mathrm{E}}^{i - j}
      \Delta a,
    \displaybreak[0]\\
    p_{\mathrm{C}}^0 &= 0,
    \\
    p_{\mathrm{C}}^i
    &= p_{\text{carrier}}
      \sum_{j = 0}^i
      p_{\text{recovery}}(r^j)
      \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^{i - j})}
      p_{\mathrm{I}}^{i - j}
      \Delta a,
    \displaybreak[0]\\
    P_{\mathrm{R}}^0 &= 0,
    \\
    \begin{split}
      \frac{P_{\mathrm{R}}^i - P_{\mathrm{R}}^{i - 1}}{\Delta a}
      &= \left(1 - p_{\text{carrier}}\right)
      \sum_{j = 0}^i
      p_{\text{recovery}}(r^j)
      \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^{i - j})}
      p_{\mathrm{I}}^{i - j}
      \Delta a
      \\ & \quad {}
      + \sum_{j = 0}^i
      p_{\text{carrier recovery}}(r^j)
      \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^{i - j})}
      p_{\mathrm{C}}^{i - j}
      \Delta a
      \\ & \quad {}
      + h_{\text{antibody gain}}
      \frac{P_{\mathrm{L}}^i + P_{\mathrm{L}}^{i - 1}}{2}
      \\ & \quad {}
      - \left[
        h_{\text{antibody loss}} + h_{\text{death}}(a^{i - 1 / 2})
      \right]
      \frac{P_{\mathrm{R}}^i + P_{\mathrm{R}}^{i - 1}}{2},
    \end{split}
    \displaybreak[0]\\
    P_{\mathrm{L}}^0 &= 0,
    \\
    \begin{split}
      \frac{P_{\mathrm{L}}^i - P_{\mathrm{L}}^{i - 1}}{\Delta a}
      &= h_{\text{antibody loss}}
      \frac{P_{\mathrm{R}}^i + P_{\mathrm{R}}^{i - 1}}{2}
      \\ & \quad {}
      - \left[
        h_{\text{antibody gain}}
        + \sigma_{\text{lost immunity}} h_{\text{infection}}
        + h_{\text{death}}(a^{i - 1 / 2})
      \right]
      \frac{P_{\mathrm{L}}^i + P_{\mathrm{L}}^{i - 1}}{2},
    \end{split}
  \end{align}
\end{subequations}
with
\begin{subequations}
  \label{eq:sums_over_r}
  \begin{align}
    P_{\mathrm{E}}^i
    &= \sum_{j = 0}^i
      S_{\text{progression}}(r^j)
      \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^{i - j})}
      p_{\mathrm{E}}^{i - j}
      \Delta a,
    \displaybreak[0]\\
    P_{\mathrm{I}}^i
    &= \sum_{j = 0}^i
      S_{\text{recovery}}(r^j)
      \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^{i - j})}
      p_{\mathrm{I}}^{i - j}
      \Delta a,
    \displaybreak[0]\\
    P_{\mathrm{C}}^i
    &= \sum_{j = 0}^i
      S_{\text{carrier recovery}}(r^j)
      \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^{i - j})}
      p_{\mathrm{C}}^{i - j}
      \Delta a.
  \end{align}
\end{subequations}

The infection hazard is
\begin{equation}
  \label{hazard_of_infection}
  h_{\text{infection}}
  = \sum_{i = 0}^{I - 1} N
  \left(
    \beta_{\text{infectious}} P_{\mathrm{I}}^i
    + \beta_{\text{carrier}} P_{\mathrm{C}}^i
  \right)
  \Delta a,
\end{equation}
and the proportion of births that have maternal immunity is
\begin{equation}
  \label{births_maternal_immunity}
  \phi_{\text{maternal immunity}}
  = \frac{
    \sum_{i = 0}^{I - 1}
    h_{\text{birth}}(a^i) \left(
      P_{\mathrm{M}}^i + P_{\mathrm{C}}^i + P_{\mathrm{R}}^i
    \right)
    \Delta a
  }{
    \sum_{i = 0}^{I - 1} h_{\text{birth}}(a^i) P^i \Delta a
  },
\end{equation}
where
\begin{equation}
  P^i =  P_{\mathrm{M}}^i + P_{\mathrm{S}}^i + P_{\mathrm{E}}^i
  + P_{\mathrm{I}}^i + P_{\mathrm{C}}^i + P_{\mathrm{R}}^i + P_{\mathrm{L}}^i,
\end{equation}
and $N$ is the population size.


\subsection{Implementation}

Numerical scheme \eqref{eq:numerical_method} can be written as
\begin{subequations}
  \begin{align}
    P_{\mathrm{M}}^0
    - \phi_{\text{maternal immunity}}
    &= 0,
    \displaybreak[0]\\
    \begin{split}
      - \left\{1
        - \left[h_{\text{waning}}(a^{i - 1 / 2})
          + h_{\text{death}}(a^{i - 1 / 2})\right]
        \frac{\Delta a}{2}\right\}
      P_{\mathrm{M}}^{i - 1}
      \\ {}
      + \left\{1
        + \left[h_{\text{waning}}(a^{i - 1 / 2})
          + h_{\text{death}}(a^{i - 1 / 2})\right]
        \frac{\Delta a}{2}\right\}
      P_{\mathrm{M}}^i
      &= 0,
    \end{split}
    \displaybreak[0]\\
    P_{\mathrm{S}}^0
    - \left(1 - \phi_{\text{maternal immunity}}\right)
    &= 0,
    \displaybreak[0]\\
    \begin{split}
      - h_{\text{waning}}(a^{i - 1 / 2}) \frac{\Delta a}{2}
      P_{\mathrm{M}}^{i - 1}
      - h_{\text{waning}}(a^{i - 1 / 2}) \frac{\Delta a}{2}
      P_{\mathrm{M}}^i
      \\ {}
      - \left\{1
        - \left[h_{\text{infection}}
          + h_{\text{death}}(a^{i - 1 / 2})\right]
        \frac{\Delta a}{2}\right\}
      P_{\mathrm{S}}^{i - 1}
      \\ {}
      + \left\{1
        + \left[h_{\text{infection}}
          + h_{\text{death}}(a^{i - 1 / 2})\right]
          \frac{\Delta a}{2}\right\}
      P_{\mathrm{S}}^i
      &= 0,
    \end{split}
    \displaybreak[0]\\
    p_{\mathrm{E}}^0 &= 0,
    \displaybreak[0]\\
    \begin{split}
      - \frac{h_{\text{infection}}}{2} P_{\mathrm{S}}^{i - 1}
      - \frac{h_{\text{infection}}}{2} P_{\mathrm{S}}^i
      \\ {}
      + p_{\mathrm{E}}^i
      \\ {}
      - \frac{\sigma_{\text{lost immunity}} h_{\text{infection}}}{2}
      P_{\mathrm{L}}^{i - 1}
      - \frac{\sigma_{\text{lost immunity}} h_{\text{infection}}}{2}
      P_{\mathrm{L}}^i
      &= 0,
    \end{split}
    \displaybreak[0]\\
    p_{\mathrm{I}}^0 &= 0,
    \\
    - \sum_{j = 0}^i p_{\text{progression}}(r^{i - j})
    \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^j)}
    \Delta a
    p_{\mathrm{E}}^j
    + p_{\mathrm{I}}^i
    &= 0,
    \displaybreak[0]\\
    p_{\mathrm{C}}^0 &= 0,
    \\
    - \sum_{j = 0}^i
    p_{\text{carrier}} p_{\text{recovery}}(r^{i - j})
    \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^j)}
    \Delta a
    p_{\mathrm{I}}^j
    + p_{\mathrm{C}}^i
    &= 0,
    \displaybreak[0]\\
    P_{\mathrm{R}}^0 &= 0,
    \\
    \begin{split}
      - \sum_{j = 0}^i
      \left(1 - p_{\text{carrier}}\right)
      p_{\text{recovery}}(r^{i - j})
      \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^j)}
      \Delta a^2
      p_{\mathrm{I}}^j
      \\ {}
      - \sum_{j = 0}^i
      p_{\text{carrier recovery}}(r^{i - j})
      \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^j)}
      \Delta a^2
      p_{\mathrm{C}}^j
      \\ {}
      - \left\{1
        - \left[h_{\text{antibody loss}}
          + h_{\text{death}}(a^{i - 1 / 2})
        \right]
        \frac{\Delta a}{2}\right\}
      P_{\mathrm{R}}^{i - 1}
      \\ {}
      + \left\{1
        + \left[h_{\text{antibody loss}}
          + h_{\text{death}}(a^{i - 1 / 2})\right]
        \frac{\Delta a}{2}\right\}
      P_{\mathrm{R}}^i
      \\ {}
      - h_{\text{antibody gain}} \frac{\Delta a}{2}
      P_{\mathrm{L}}^{i - 1}
      - h_{\text{antibody gain}} \frac{\Delta a}{2}
      P_{\mathrm{L}}^i
      &= 0,
    \end{split}
    \displaybreak[0]\\
    P_{\mathrm{L}}^0 &= 0,
    \\
    \begin{split}
      - h_{\text{antibody loss}} \frac{\Delta a}{2}
      P_{\mathrm{R}}^{i - 1}
      - h_{\text{antibody loss}} \frac{\Delta a}{2}
      P_{\mathrm{R}}^i
      \\ {}
      - \left\{1
        - \left[h_{\text{antibody gain}}
          + \sigma_{\text{lost immunity}} h_{\text{infection}}
          + h_{\text{death}}(a^{i - 1 / 2})
        \right]
        \frac{\Delta a}{2}\right\}
      P_{\mathrm{L}}^{i - 1}
      \\ {}
      + \left\{1
        + \left[h_{\text{antibody gain}}
          + \sigma_{\text{lost immunity}} h_{\text{infection}}
          + h_{\text{death}}(a^{i - 1 / 2})
        \right]
        \frac{\Delta a}{2}\right\}
      P_{\mathrm{L}}^i
      &= 0,
    \end{split}
  \end{align}
\end{subequations}
for $i \in \{1, 2, \ldots, I - 1\}$.

Define the vectors
\begin{equation}
  \vec{P}_X =
  \begin{pmatrix}
    P_X^0\\
    P_X^1\\
    \vdots\\
    P_X^{I - 1}
  \end{pmatrix}
  \qquad
  \text{for $X \in
    \left\{\mathrm{M}, \mathrm{S}, \mathrm{R}, \mathrm{L}\right\}$},
\end{equation}
and
\begin{equation}
  \vec{p}_Y =
  \begin{pmatrix}
    p_Y^0\\
    p_Y^1\\
    \vdots\\
    p_Y^{I - 1}
  \end{pmatrix}
  \qquad
  \text{for $Y \in
    \left\{\mathrm{E}, \mathrm{I}, \mathrm{C}\right\}$}.
\end{equation}
Let $\vec{v}$ be the $\vec{P}_X$'s and $\vec{p}_Y$'s stacked into a
single vector of length $7 I$,
\begin{equation}
  \vec{v} =
  \begin{pmatrix}
    \vec{P}_{\mathrm{M}}\\
    \vec{P}_{\mathrm{S}}\\
    \vec{p}_{\mathrm{E}}\\
    \vec{p}_{\mathrm{I}}\\
    \vec{p}_{\mathrm{C}}\\
    \vec{P}_{\mathrm{R}}\\
    \vec{P}_{\mathrm{L}}
  \end{pmatrix}.
\end{equation}

Define the $7 I \times 7 I$ block diagonal matrix
\begin{align}
  \mat{D} &=
  \begin{bmatrix}
    \mat{D}_{\mathrm{M}} & \mat{0} & \mat{0} &
    \mat{0} & \mat{0} & \mat{0} & \mat{0}
    \\
    \mat{0} & \mat{D}_{\mathrm{S}} & \mat{0} &
    \mat{0} & \mat{0} & \mat{0} & \mat{0}
    \\
    \mat{0} & \mat{0} & \bar{\mat{D}}_{\mathrm{E}} &
    \mat{0} & \mat{0} & \mat{0} & \mat{0}
    \\
    \mat{0} & \mat{0} & \mat{0} &
    \bar{\mat{D}}_{\mathrm{I}} & \mat{0} & \mat{0} & \mat{0}
    \\
    \mat{0} & \mat{0} & \mat{0} & \mat{0} &
    \bar{\mat{D}}_{\mathrm{C}} & \mat{0} & \mat{0}
    \\
    \mat{0} & \mat{0} & \mat{0} & \mat{0} &
    \mat{0} & \mat{D}_{\mathrm{R}} & \mat{0}
    \\
    \mat{0} & \mat{0} & \mat{0} & \mat{0} &
    \mat{0} & \mat{0} & \mat{D}_{\mathrm{L}}
  \end{bmatrix},
\end{align}
with $I \times I$ blocks
\begin{subequations}
  \begin{align}
    \mat{D}_X &=
    \begin{bmatrix}
      1 & 0 & 0 & \hdots & 0
      \\
      - 1 + d_X^1 & 1 + d_X^1 & 0 & \hdots & 0
      \\
      0 & - 1 + d_X^2 & 1 + d_X^2 & \ddots & \vdots
      \\
      \vdots & \ddots & \ddots & \ddots & 0
      \\
      0 & \hdots & 0 & - 1 + d_X^{I - 1} & 1 + d_X^{I - 1}
    \end{bmatrix},
    \\
    \bar{\mat{D}}_Y &=
    \mat{I}_{I \times I} =
    \begin{bmatrix}
      1 & 0 & \hdots & 0 \\
      0 & 1 & \ddots & \vdots \\
      \vdots & \ddots & \ddots & 0 \\
      0 & \hdots & 0 & 1
    \end{bmatrix},
  \end{align}
\end{subequations}
where
\begin{subequations}
  \begin{align}
    d_{\mathrm{M}}^i
    &= \frac{1}{2} \left[h_{\text{waning}}(a^{i - 1 / 2})
      + h_{\text{death}}(a^{i - 1 / 2})\right]
      \Delta a,
    \\
    d_{\mathrm{S}}^i
    &= \frac{1}{2} \left[h_{\text{infection}}
      + h_{\text{death}}(a^{i - 1 / 2})\right]
      \Delta a,
    \\
    d_{\mathrm{R}}^i
    &= \frac{1}{2} \left[h_{\text{antibody loss}}
      + h_{\text{death}}(a^{i - 1 / 2})\right]
      \Delta a,
    \\
    d_{\mathrm{L}}^i
    &= \frac{1}{2} \left[h_{\text{antibody gain}}
      + \sigma_{\text{lost immunity}} h_{\text{infection}}
      + h_{\text{death}}(a^{i - 1 / 2})\right]
      \Delta a,
  \end{align}
\end{subequations}
for $i \in \{1, 2, \ldots, I - 1\}$.

Define the $7 I \times 7 I$ influx matrix
\begin{equation}
  \mat{F} =
  \begin{bmatrix}
    \mat{0} & \mat{0} & \mat{0} & \mat{0} &
    \mat{0} & \mat{0} & \mat{0}
    \\
    \mat{F}_{\mathrm{SM}} & \mat{0} & \mat{0} &
    \mat{0} & \mat{0} & \mat{0} & \mat{0}
    \\
    \mat{0} & \mat{F}_{\mathrm{ES}} & \mat{0} &
    \mat{0} & \mat{0} & \mat{0} & \mat{F}_{\mathrm{EL}}
    \\
    \mat{0} & \mat{0} & \bar{\mat{F}}_{\mathrm{IE}} &
    \mat{0} & \mat{0} & \mat{0} & \mat{0}
    \\
    \mat{0} & \mat{0} & \mat{0} & \bar{\mat{F}}_{\mathrm{CI}} &
    \mat{0} & \mat{0} & \mat{0}
    \\
    \mat{0} & \mat{0} & \mat{0} & \bar{\mat{F}}_{\mathrm{RI}} &
    \bar{\mat{F}}_{\mathrm{RC}} & \mat{0} & \mat{F}_{\mathrm{RL}}
    \\
    \mat{0} & \mat{0} & \mat{0} & \mat{0} &
    \mat{0} & \mat{F}_{\mathrm{LR}} & \mat{0}
  \end{bmatrix},
\end{equation}
with $I \times I$ blocks
\begin{subequations}
  \begin{align}
    \mat{F}_{ZX} &=
    \begin{bmatrix}
      0 & 0 & 0 & \hdots & 0
      \\
      f_{ZX}^1 & f_{ZX}^1 & 0 & \hdots & 0
      \\
      0 & f_{ZX}^2 & f_{ZX}^2 & \ddots & \vdots
      \\
      \vdots & \ddots & \ddots & \ddots & 0
      \\
      0 & \hdots & 0 & f_{ZX}^{I - 1} &
      f_{ZX}^{I - 1}
    \end{bmatrix},
    \displaybreak[0]\\
    \bar{\mat{F}}_{ZY} &=
    \begin{bmatrix}
      0 & 0 & \hdots & 0
      \\
      \bar{f}_{ZY}^{1, 0} & \bar{f}_{ZY}^{1, 1} & \ddots & \vdots
      \\
      \vdots & \vdots & \ddots & 0
      \\
      \bar{f}_{ZY}^{I - 1, 0} & \bar{f}_{ZY}^{I - 1, 1} & \hdots &
      \bar{f}_{ZY}^{I - 1, I - 1}
    \end{bmatrix},
  \end{align}
\end{subequations}
where
\begin{subequations}
  \begin{align}
    f_{\mathrm{SM}}^i &=
    \frac{1}{2} h_{\text{waning}}(a^{i - 1 / 2}) \Delta a,
    \displaybreak[0]\\
    f_{\mathrm{ES}}^i &=
    \frac{1}{2} h_{\text{infection}},
    \displaybreak[0]\\
    f_{\mathrm{EL}}^i &=
    \frac{1}{2} \sigma_{\text{lost immunity}} h_{\text{infection}},
    \displaybreak[0]\\
    f_{\mathrm{RL}}^i &=
    \frac{1}{2} h_{\text{antibody gain}} \Delta a,
    \displaybreak[0]\\
    f_{\mathrm{LR}}^i &=
    \frac{1}{2} h_{\text{antibody loss}} \Delta a,
    \displaybreak[0]\\
    \bar{f}_{\mathrm{IE}}^{i, j} &=
    p_{\text{progression}}(r^{i - j})
    \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^j)}
    \Delta a,
    \displaybreak[0]\\
    \bar{f}_{\mathrm{CI}}^{i, j} &=
    p_{\text{carrier}} p_{\text{recovery}}(r^{i - j})
    \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^j)}
    \Delta a,
    \displaybreak[0]\\
    \bar{f}_{\mathrm{RI}}^{i, j} &=
    (1 - p_{\text{carrier}}) p_{\text{recovery}}(r^{i - j})
    \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^j)}
    \Delta a^2,
    \displaybreak[0]\\
    \bar{f}_{\mathrm{RC}}^{i, j} &=
    p_{\text{carrier recovery}}(r^{i - j})
    \frac{S_{\text{death}}(a^i)}{S_{\text{death}}(a^j)}
    \Delta a^2.
  \end{align}
\end{subequations}

Define the vector of length $7 I$
\begin{equation}
  \vec{b} =
  \begin{pmatrix}
    \vec{b}_{\mathrm{M}} \\
    \vec{b}_{\mathrm{S}} \\
    \vec{0} \\
    \vec{0} \\
    \vec{0} \\
    \vec{0} \\
    \vec{0}
  \end{pmatrix},
\end{equation}
with the blocks of length $I$
\begin{subequations}
  \begin{align}
    \vec{b}_{\mathrm{M}} &=
    \begin{pmatrix}
      \phi_{\text{maternal immunity}} \\
      0 \\
      \vdots \\
      0
    \end{pmatrix},
    \displaybreak[0]\\
    \vec{b}_{\mathrm{S}} &=
    \begin{pmatrix}
      1 - \phi_{\text{maternal immunity}} \\
      0 \\
      \vdots \\
      0
    \end{pmatrix}.
  \end{align}
\end{subequations}

Define the matrix
\begin{equation}
  \mat{A} =
  \mat{D} - \mat{F}.
\end{equation}
The numerical scheme is then finding the vector $\vec{v}$ that solves
\begin{equation}
  \mat{A} \vec{v} = \vec{b}.
\end{equation}


\subsection{Endemic equilibrium}

In our implementation of the Crank--Nicolson method on
characteristics, the matrix $\mat{A}$
depends on the hazard of infection, $h_{\text{infection}}$,
while the vector $\vec{b}$
depends on the fraction of newborns with maternal immunity,
$\phi_{\text{maternal immunity}}$.
We used a fixed-point solver, \verb|scipy.optimize.fixed_point()|
\autocite{scipy}, to find the values of $h_{\text{infection}}$
and $\phi_{\text{maternal immunity}}$ at the endemic equilibrium.
For trial values of $h_{\text{infection}}$ and
$\phi_{\text{maternal immunity}}$, we used our implementation of the
Crank--Nicolson method on characteristics to find the vector of state
probabilities $\vec{v}$ and then from those state probabilities, we
calculated the resulting new values of $h_{\text{infection}}$ from
\eqref{hazard_of_infection} and $\phi_{\text{maternal immunity}}$ from
\eqref{births_maternal_immunity}. The fixed-point solver then found
the values of $h_{\text{infection}}$ and
$\phi_{\text{maternal immunity}}$ at the endemic equilibrium and from
those we used the Crank--Nicolson solver to find the state
probabilities at the endemic equilibrium.


\printbibliography


\end{document}
